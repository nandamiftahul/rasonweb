<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Radiosonde FTP Dashboard</title>
  <style>
    body {
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f8fafc;
      color: #222;
    }
  
    header {
      background: #0d6efd;
      color: white;
      padding: 20px;
      text-align: center;
      position: relative;
    }
    header h1 { margin: 0; font-size: 28px; }
  
    .logout {
      position: absolute; top: 15px; right: 20px;
    }
    .logout a {
      background: white;
      color: #0d6efd;
      padding: 6px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 500;
      transition: background 0.2s;
    }
    .logout a:hover { background: #e9ecef; }
  
    main {
      max-width: 1600px;
      margin: 20px auto;
      padding: 0 20px;
    }
  
    .card {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
  
    h2 {
      margin-top: 0;
      color: #0d6efd;
      border-bottom: 2px solid #0d6efd33;
      padding-bottom: 5px;
    }
  
    .filters {
      text-align: center;
      margin: 10px 0 20px 0;
    }
    select, button {
      padding: 6px 12px;
      margin: 0 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button {
      background: #0d6efd;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover { background: #0b5ed7; }
  
    table.dataTable {
      width: 100% !important;
      margin-top: 10px !important;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
  
    /* Progress overlay */
    #progressOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      flex-direction: column;
    }
    .progress-bar {
      width: 60%; height: 20px;
      background: #eee;
      border-radius: 10px;
      overflow: hidden;
    }
    .progress-bar-inner {
      width: 0%; height: 100%;
      background: #0d6efd;
      animation: progressAnim 2s infinite;
    }
    @keyframes progressAnim {
      0% { width: 0%; }
      50% { width: 80%; }
      100% { width: 0%; }
    }
  
    /* Status colors */
    .status-ok { color: green; font-weight: bold; }
    .status-warn { color: orange; font-weight: bold; }
    .status-issues { color: red; font-weight: bold; }
  
    .link-box {
      text-align:center;
      margin-top:20px;
    }
    .link-box a {
      display:inline-block;
      padding:8px 14px;
      background:#0d6efd;
      color:white;
      border-radius:6px;
      text-decoration:none;
      transition: background 0.2s;
    }
    .link-box a:hover { background:#0b5ed7; }
  
    /* ==============================
       DataTable adjustments
       ============================== */
    #dataTable {
      width: 100% !important;
      table-layout: fixed;      /* ensures header/body alignment */
      font-size: 14px;
      border-collapse: collapse;
    }
  
    #dataTable th, #dataTable td {
      white-space: normal;   /* allow text to wrap */
      word-wrap: break-word; /* break long words if needed */
      overflow-wrap: break-word; /* modern browsers */
      padding: 8px 12px;
      vertical-align: top;   /* align text nicely at the top */
    }
  
    /* Fix DataTables header/body width mismatch */
    .dataTables_wrapper .dataTables_scrollHeadInner,
    .dataTables_wrapper .dataTables_scrollHead table {
      width: 100% !important;
    }
  
    /* Allow horizontal scroll when too many columns */
    .dataTables_wrapper {
      overflow-x: auto;
    }

    /* Site column small */
    #dataTable th:nth-child(1),
    #dataTable td:nth-child(1) {
      min-width: 80px !important;
      max-width: 100px !important;
      width: 100px !important;
    }

    /* Column width adjustments */
    #dataTable th:nth-child(2),
    #dataTable td:nth-child(2) {
      min-width: 50px !important;   /* Filename wider */
      width: 50px !important;
    }
  
    #dataTable th:nth-child(5),
    #dataTable td:nth-child(5) {
      min-width: 110px !important;   /* Status medium */
      width: 110px !important;
    }
  
    /* Always make the last 3 columns (.bfr, WMO, RAOB) narrow */
    #dataTable th:nth-last-child(3),
    #dataTable td:nth-last-child(3),
    #dataTable th:nth-last-child(2),
    #dataTable td:nth-last-child(2),
    #dataTable th:nth-last-child(1),
    #dataTable td:nth-last-child(1) {
      min-width: 20px !important;
      max-width: 30px !important;
      width: 30px !important;
      text-align: center !important;
    }
  </style>


  <!-- âœ… DataTables CSS/JS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
</head>
<body>
  <header>
    <h1>Radiosonde FTP Dashboard</h1>
    <div class="logout"><a href="{{ url_for('logout') }}">ðŸšª Logout</a></div>
  </header>

  <!-- Progress overlay -->
  <div id="progressOverlay">
    <div class="progress-bar"><div class="progress-bar-inner"></div></div>
    <p>Processing files, please wait...</p>
  </div>

  <main>

    <!-- Filters card -->
    <div class="card">
      <h2>Filters</h2>
      <div class="filters">
        <form id="filterForm">
          <label for="ext">File Type:</label>
          <select name="ext" id="ext">
            <option value=".bufr" {% if selected_ext==".bufr" %}selected{% endif %}>.bufr</option>
            <option value=".bfh" {% if selected_ext==".bfh" %}selected{% endif %}>.bfh</option>
            <option value=".bfr" {% if selected_ext==".bfr" %}selected{% endif %}>.bfr</option>
            <option value=".bin" {% if selected_ext==".bin" %}selected{% endif %}>.bin</option>
            <option value="" {% if not selected_ext or selected_ext=="all" %}selected{% endif %}>All</option>
          </select>

          <label for="limit">Files per site:</label>
          <select name="limit" id="limit">
            <option value="2" {% if limit==2 %}selected{% endif %}>2</option>
            <option value="5" {% if limit==5 %}selected{% endif %}>5</option>
            <option value="10" {% if limit==10 %}selected{% endif %}>10</option>
            <option value="20" {% if limit==20 %}selected{% endif %}>20</option>
            <option value="50" {% if limit==50 %}selected{% endif %}>50</option>
          </select>

          <button type="submit">Apply</button>
          <button type="button" onclick="showMetadata()">Show Metadata</button>
        </form>
      </div>
    </div>

    <!-- Table card -->
    <div class="card">
      <h2>Files</h2>
      <div id="content"></div>
    </div>

    <!-- Navigation -->
    <div class="link-box">
      <a href="{{ url_for('index') }}">âž¡ Go to Radiosonde Viewer</a>
    </div>

  </main>

  <script>
    async function loadSites(params="") {
      try {
        const res = await fetch("/api/sites" + params);
        const sites = await res.json();
        renderTable(sites, false);
      } catch (err) {
        document.getElementById("content").innerHTML =
          `<p style="color:red;">Error loading sites: ${err}</p>`;
      }
    }

    function renderTable(sites, withMeta) {
      let html = `<table id="dataTable" class="display"><thead><tr>
        <th>Site</th>
        <th>File</th>
        <th>Data Date</th>`;
    
      if (withMeta) {
        html += `
          <th>Launch Time</th>
          <th>End Time</th>
          <th>Status</th>
          <th>Reason of End</th>
          <th>Serial</th>
          <th>End Pressure</th>
          <th>Max Height</th>
          <th>Distance</th>
          <th>Avg Ascent</th>`;
      }
    
      html += `
        <th>.bfr</th>
        <th>WMO</th>
        <th>RAOB</th>
      </tr></thead><tbody>`;
    
      for (const [site, files] of Object.entries(sites)) {
        files.forEach(f => {
          html += `<tr>
            <td>${f.site || site}</td>
            <td style="text-align:center;">
              <a href="/load_from_ftp/${site}/${f.name}" target="_blank" title="${f.name}">
                ðŸ“„
              </a>
            </td>
            <td>${f.file_date || "-"}</td>`;
    
          if (withMeta) {
            let issues = f.flight_issues || "-";
            if (Array.isArray(issues)) issues = issues.join(", ");
            let statusClass = "status-ok";
            if (issues.includes("Ascent Stop") || issues.includes("Not reaching")) statusClass = "status-warn";
            else if (issues !== "OK" && issues !== "-") statusClass = "status-issues";
    
            html += `<td>${f.launch_time || "-"}</td>`;
            html += `<td>${f.end_time || "-"}</td>`
            html += `<td class="${statusClass}">${issues}</td>`;
            html += `<td>${f.reason_for_termination || "-"}</td>`;
            html += `<td>${f.radiosonde_serial_number || "-"}</td>`;;
            html += `<td>${f.end_pressure || "-"}</td>`;
            html += `<td>${f.max_height || "-"}</td>`;
            html += `<td>${f.end_distance || "-"}</td>`;
            html += `<td>${f.avg_ascent_rate || "-"}</td>`;
          }
    
          html += `<td><a href="/download/${site}/${f.name}" target="_blank">â¬‡</a></td>`;
          html += `<td><a href="/download_wmo/${site}/${f.name}" target="_blank">â¬‡</a></td>`;
          html += `<td><a href="/raob/${site}/${f.name}" target="_blank">ðŸ“Š</a></td>`;
          html += `</tr>`;
        });
      }
    
      html += "</tbody></table>";
      document.getElementById("content").innerHTML = html;
    
      // Destroy any previous instance (prevents double-inits and misalignment)
      if ($.fn.DataTable.isDataTable('#dataTable')) {
        $('#dataTable').DataTable().destroy();
      }
      
      // Initialize with scroll and then adjust columns
      $('#dataTable').DataTable({
        scrollX: true,
        autoWidth: false,
        ordering: false,                // optional, removes width jitter from sort icons
        drawCallback: function () {     // ensure final alignment after draw
          this.api().columns.adjust();
        }
      });

    }


    async function showMetadata() {
      document.getElementById("progressOverlay").style.display = "flex";
      try {
        const ext = document.getElementById("ext").value;
        const limit = document.getElementById("limit").value;
        const params = `?ext=${encodeURIComponent(ext)}&limit=${encodeURIComponent(limit)}`;
        const res = await fetch("/api/sites_with_meta" + params);
        const sites = await res.json();
        renderTable(sites, true);
      } catch (err) {
        document.getElementById("content").innerHTML =
          `<p style="color:red;">Error loading metadata: ${err}</p>`;
      } finally {
        document.getElementById("progressOverlay").style.display = "none";
      }
    }

    loadSites("?ext={{ selected_ext }}&limit={{ limit }}");

    document.getElementById("filterForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const ext = document.getElementById("ext").value;
      const limit = document.getElementById("limit").value;
      const params = `?ext=${encodeURIComponent(ext)}&limit=${encodeURIComponent(limit)}`;
      loadSites(params);
    });
  </script>
</body>
</html>
