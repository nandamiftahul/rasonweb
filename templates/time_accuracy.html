<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Time Accuracy - Radiosonde Monitoring</title>
  <link href="{{ url_for('static', filename='libs/fonts/inter/inter.css') }}" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      display: flex;
      flex-direction: row;
      min-height: 100vh;
      background: linear-gradient(to bottom right, #0a2a6b, #004aad, #0078d7);
      color: white;
      overflow-y: auto;
      transition: all 0.3s ease;
    }

    /* Sidebar */
    .sidebar {
      width: 230px;
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(8px);
      border-right: 1px solid rgba(255,255,255,0.15);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 10px;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      z-index: 10;
      transition: transform 0.3s ease;
    }

    .sidebar.hidden { transform: translateX(-240px); }

    .sidebar h2 { font-size: 18px; margin-bottom: 30px; color: #dbeafe; text-align: center; }
    .sidebar a {
      display: block; text-decoration: none; color: white;
      width: 100%; padding: 12px 15px; border-radius: 8px;
      text-align: left; margin: 8px 0; transition: background 0.3s;
    }
    .sidebar a:hover { background: rgba(255,255,255,0.15); }
    .logout { margin-top: auto; font-size: 14px; padding: 8px 14px; background: rgba(255,255,255,0.1); border-radius: 6px; color: #fca5a5; text-decoration: none; }
    .logout:hover { background: rgba(255,255,255,0.2); }

    /* Tombol toggle */
    .toggle-btn {
      position: fixed;
      top: 50%;
      left: 220px;
      transform: translateY(-50%);
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 50%;
      background: rgba(255,255,255,0.25);
      color: white;
      font-size: 14px;
      cursor: pointer;
      z-index: 50;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .toggle-btn:hover { background: rgba(255,255,255,0.4); }
    .toggle-btn.hidden-position { left: 10px; }

    /* Main */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 40px;
      margin-left: 230px;
      transition: margin-left 0.3s ease;
    }

    .main.expanded { margin-left: 0; }

    /* Header box (same as main.html) */
    .header-box {
      position: relative;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 20px 30px;
      box-shadow: 0 6px 25px rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 18px;
      margin-bottom: 35px;
    }

    .header-icon {
      width: 50px; height: 50px; background: rgba(255,255,255,0.15);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 26px; color: #dbeafe;
    }

    .header-text h1 { margin: 0; font-size: 26px; font-weight: 600; letter-spacing: 0.5px; }
    .header-text p { margin: 4px 0 0; font-size: 14px; color: #dbeafe; opacity: 0.9; }

    .header-logos { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); display: flex; gap: 12px; align-items: center; }
    .header-logos img { height: 36px; opacity: 0.9; }

    /* Chart + controls */
    .selector {
      margin-bottom: 30px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    select {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      outline: none;
      font-size: 15px;
      background: rgba(255,255,255,0.9);
      color: #003366;
    }

    .chart-box {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      padding: 25px 30px;
      width: 95%;
      max-width: 1300px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }

    canvas { width: 100% !important; height: 500px !important; }
    .loading { font-size: 15px; color: #dbeafe; margin-top: 20px; }
    .summary { margin-top: 20px; margin-bottom: 40px;  font-size: 14px; color: #e0e7ff; text-align: center; }

    /* Footer */
    .footer {
      background: #ffffff;
      padding: 4px 0;                     /* üîΩ sangat tipis */
      display: flex;
      justify-content: center;
      align-items: center;
      border-top: 1px solid #d1d5db;      /* garis abu muda */
      border-radius: 0 0 8px 8px;
      height: 38px;                       /* üîΩ batasi tinggi maksimum */
    }
    
    .footer span {
      color: #333;
      font-weight: 500;
      margin-right: 6px;
      font-size: 12px;                    /* üîΩ kecil dan elegan */
      opacity: 0.8;
    }
    
    .footer img {
      height: 28px;                       /* üîΩ kecilkan logo */
      opacity: 0.85;
      margin: 0 6px;
      filter: saturate(90%);
    }
  </style>
</head>

<body>

  <!-- Tombol toggle -->
  <button class="toggle-btn" id="toggleBtn" onclick="toggleSidebar()">‚ùÆ</button>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <h2>Radiosonde Monitoring</h2>
  
    <!-- üè† Main Page -->
    <a href="{{ url_for('main_page') }}">üè† Main Page</a>
  
    <!-- üìä Data Resume -->
    <a href="{{ url_for('dashboard') }}">üìä Data Resume</a>
  
    <!-- üó∫Ô∏è Map (new tab) -->
    <a href="{{ url_for('index') }}" target="_blank">üó∫Ô∏è Map</a>
  
    <!-- üåê 3D Trajectory (new tab) -->
    <a href="{{ url_for('trajectory3d_page') }}" target="_blank">üåê Trajectory 3D</a>
  
    <!-- ‚è±Ô∏è Time Accuracy -->
    <a href="{{ url_for('time_accuracy') }}">‚è±Ô∏è Time Accuracy</a>
  
    <!-- üìà Height Reach -->
    <a href="{{ url_for('height_reach') }}">üìà Height Reach Graph</a>
  
    <!-- ‚öôÔ∏è Settings -->
    <a href="{{ url_for('settings_page') }}">‚öôÔ∏è Settings</a>
  
    <!-- üö™ Logout -->
    <a href="{{ url_for('logout') }}" class="logout">üö™ Logout</a>
  </div>


  <!-- Main -->
  <div class="main" id="mainContent">
    <!-- Header -->
    <div class="header-box">
      <div class="header-icon">‚è±Ô∏è</div>
      <div class="header-text">
        <h1>Time Accuracy Monitoring</h1>
        <p>Balloon time to reach 100 hPa (blue) and 30 hPa (red) ‚Äî current month</p>
      </div>
      <div class="header-logos">
        <img src="{{ url_for('static', filename='images/bmkg.png') }}" alt="BMKG">
      </div>
    </div>

    <!-- Controls -->
    <div class="selector">
      <label for="siteSelect">Site:</label>
      <select id="siteSelect"></select>

      <label for="timeSelect">Launch Time:</label>
      <select id="timeSelect">
        <option value="ALL" selected>All</option>
        <option value="00Z">00Z</option>
        <option value="12Z">12Z</option>
      </select>
    </div>

    <!-- Chart -->
    <div class="chart-box">
      <canvas id="timeAccuracyChart"></canvas>
      <div id="loadingMsg" class="loading">Loading data...</div>
    </div>

    <div id="summary" class="summary"></div>

    <!-- Footer -->
    <div class="footer">
      <span>Powered by</span>
      <img src="{{ url_for('static', filename='images/meteomodem.png') }}" alt="Meteomodem Logo">
      <img src="{{ url_for('static', filename='images/terrindofull.png') }}" alt="Terrindo Logo">
    </div>
  </div>

  <script>
    // Sidebar toggle
    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const main = document.getElementById("mainContent");
      const btn = document.getElementById("toggleBtn");
      sidebar.classList.toggle("hidden");
      main.classList.toggle("expanded");
      if (sidebar.classList.contains("hidden")) {
        btn.textContent = "‚ò∞";
        btn.classList.add("hidden-position");
      } else {
        btn.textContent = "‚ùÆ";
        btn.classList.remove("hidden-position");
      }
    }

    // Chart logic (same as before)
    const ctx = document.getElementById("timeAccuracyChart").getContext("2d");
    const loadingMsg = document.getElementById("loadingMsg");
    const summaryDiv = document.getElementById("summary");
    const siteSelect = document.getElementById("siteSelect");
    const timeSelect = document.getElementById("timeSelect");
    let chart = null;
    let allData = [];

    async function loadSites() {
      loadingMsg.textContent = "Loading sites...";
      const now = new Date();
      const start = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1));
      const end = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth() + 1, 1));
      const toYMD = d => d.toISOString().slice(0,10);
      try {
        const res = await fetch(`/api/sites?ext=.bfr&start_date=${toYMD(start)}&end_date=${toYMD(end)}`);
        const siteMap = await res.json();
        let sites = Object.keys(siteMap).sort();
        if (sites.length === 0) {
          siteSelect.innerHTML = `<option disabled selected>No sites found</option>`;
          return;
        }
        siteSelect.innerHTML = "";
        sites.forEach(s => {
          const opt = document.createElement("option");
          opt.value = s;
          opt.textContent = s;
          siteSelect.appendChild(opt);
        });
        siteSelect.value = sites[0];
        loadTimeAccuracy(sites[0]);
      } catch (err) {
        loadingMsg.textContent = "Failed to load sites.";
      }
    }

    async function loadTimeAccuracy(site) {
      loadingMsg.textContent = `Fetching data for ${site}...`;
      summaryDiv.textContent = "";
      try {
        const res = await fetch(`/api/time_accuracy/${site}`);
        const json = await res.json();
        allData = json.data || [];
        renderChart();
      } catch (err) {
        loadingMsg.textContent = "Failed to load data.";
      }
    }

    function renderChart() {
      const filterTime = timeSelect.value;
      const now = new Date();
      const year = now.getUTCFullYear();
      const month = now.getUTCMonth();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      let labels = [];
      let AB = [];
      let CD = [];
      if (filterTime === "ALL") {
        for (let d = 1; d <= daysInMonth; d++) {
          const day = d.toString().padStart(2, "0");
          labels.push(`${day} (00Z)`);
          labels.push(`${day} (12Z)`);
        }
        const map = {};
        allData.forEach(d => map[`${d.date}_${d.hour}`] = d);
        AB = labels.map(lbl => {
          const [day, tag] = lbl.split(" ");
          const h = tag.replace(/[()]/g, "");
          const entry = map[`${year}-${(month+1).toString().padStart(2,"0")}-${day}_${h}`];
          return entry ? entry.AB : null;
        });
        CD = labels.map(lbl => {
          const [day, tag] = lbl.split(" ");
          const h = tag.replace(/[()]/g, "");
          const entry = map[`${year}-${(month+1).toString().padStart(2,"0")}-${day}_${h}`];
          return entry ? entry.CD : null;
        });
      } else {
        for (let d = 1; d <= daysInMonth; d++) {
          const day = d.toString().padStart(2, "0");
          labels.push(day);
        }
        const map = {};
        allData.forEach(d => map[`${d.date}_${d.hour}`] = d);
        AB = labels.map(day => {
          const entry = map[`${year}-${(month+1).toString().padStart(2,"0")}-${day}_${filterTime}`];
          return entry ? entry.AB : null;
        });
        CD = labels.map(day => {
          const entry = map[`${year}-${(month+1).toString().padStart(2,"0")}-${day}_${filterTime}`];
          return entry ? entry.CD : null;
        });
      }

      loadingMsg.style.display = "none";
      const validAB = AB.filter(v => v !== null);
      const validCD = CD.filter(v => v !== null);
      const avgAB = validAB.length ? (validAB.reduce((a,b)=>a+b,0)/validAB.length).toFixed(1) : "-";
      const avgCD = validCD.length ? (validCD.reduce((a,b)=>a+b,0)/validCD.length).toFixed(1) : "-";
      summaryDiv.textContent = `Average A‚ÄìB: ${avgAB} min | Average C‚ÄìD: ${avgCD} min`;

      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "A‚ÄìB (100 hPa)", data: AB, backgroundColor: "rgba(59,130,246,0.85)", stack: "stack1" },
            { label: "C‚ÄìD (30 hPa)", data: CD, backgroundColor: "rgba(239,68,68,0.85)", stack: "stack1" }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: "index", intersect: false },
          scales: {
            x: {
              title: { display: true, text: "Tanggal (UTC)", color: "#fff" },
              ticks: {
                color: "#fff",
                callback: (value, index) => filterTime === "ALL" ? 
                  (labels[index].includes("(00Z)") ? labels[index].slice(0,2) : "") : labels[index]
              },
              grid: { color: "rgba(255,255,255,0.1)" },
              stacked: true
            },
            y: {
              title: { display: true, text: "Waktu (menit)", color: "#fff" },
              ticks: { color: "#fff" },
              grid: { color: "rgba(255,255,255,0.1)" },
              beginAtZero: true,
              max: 180
            }
          },
          plugins: {
            legend: { labels: { color: "#fff" } },
            title: {
              display: true,
              text: `Time Accuracy - ${siteSelect.value} (${filterTime})`,
              color: "#fff",
              font: { size: 18 }
            },
            tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y ?? "No data"} menit` } }
          }
        }
      });
    }

    siteSelect.addEventListener("change", () => loadTimeAccuracy(siteSelect.value));
    timeSelect.addEventListener("change", renderChart);
    loadSites();
  </script>
</body>
</html>
