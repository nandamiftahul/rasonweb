<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Radiosonde Data Resume</title>

  <!-- Fonts + DataTables -->
  <link rel="stylesheet" href="{{ url_for('static', filename='libs/fonts/inter/inter.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='libs/datatables/datatables.min.css') }}">
  <script src="{{ url_for('static', filename='libs/jquery/jquery-3.6.0.min.js') }}"></script>
  <script src="{{ url_for('static', filename='libs/datatables/datatables.min.js') }}"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      display: flex;
      flex-direction: row;
      min-height: 100vh;
      background: linear-gradient(to bottom right, #0a2a6b, #004aad, #0078d7);
      color: white;
      overflow-y: auto;
      transition: all 0.3s ease;
    }

    /* Sidebar */
    .sidebar {
      width: 230px;
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(8px);
      border-right: 1px solid rgba(255,255,255,0.15);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 10px;
      position: fixed;
      top: 0; left: 0;
      height: 100vh;
      z-index: 10;
      transition: transform 0.3s ease;
    }
    .sidebar.hidden { transform: translateX(-240px); }

    .sidebar h2 { font-size: 18px; margin-bottom: 30px; color: #dbeafe; text-align: center; }
    .sidebar a {
      display: block; text-decoration: none; color: white;
      width: 100%; padding: 12px 15px; border-radius: 8px;
      text-align: left; margin: 8px 0; transition: background 0.3s;
    }
    .sidebar a:hover { background: rgba(255,255,255,0.15); }
    .logout { margin-top: auto; font-size: 14px; padding: 8px 14px; background: rgba(255,255,255,0.1); border-radius: 6px; color: #fca5a5; text-decoration: none; }
    .logout:hover { background: rgba(255,255,255,0.2); }

    /* Toggle button */
    .toggle-btn {
      position: fixed;
      top: 50%;
      left: 220px;
      transform: translateY(-50%);
      width: 28px; height: 28px;
      border: none;
      border-radius: 50%;
      background: rgba(255,255,255,0.25);
      color: white;
      font-size: 14px;
      cursor: pointer;
      z-index: 50;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }
    .toggle-btn.hidden-position { left: 10px; }
    .toggle-btn:hover { background: rgba(255,255,255,0.4); }

    /* Main area */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 40px;
      margin-left: 230px;
      transition: margin-left 0.3s ease;
      width: calc(100% - 230px);
    }
    .main.expanded { margin-left: 0; width: 100%; }

    /* Header */
    .header-box {
      position: relative;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 20px 30px;
      box-shadow: 0 6px 25px rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 18px;
      margin-bottom: 35px;
    }
    .header-icon {
      width: 50px; height: 50px; background: rgba(255,255,255,0.15);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 26px; color: #dbeafe;
    }
    .header-text h1 { margin: 0; font-size: 26px; font-weight: 600; }
    .header-text p { margin: 4px 0 0; font-size: 14px; color: #dbeafe; opacity: 0.9; }
    .header-logos { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); }
    .header-logos img { height: 36px; opacity: 0.9; }

    /* Card */
    .card {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      padding: 20px 25px;
      margin-bottom: 25px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }

    h2 { margin-top: 0; color: #fff; font-weight: 600; }

    select, button, input[type="date"] {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
      outline: none;
    }
    button {
      background: #0d6efd;
      color: white;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #0b5ed7; }

    /* DataTables */
    .dataTables_wrapper { width: 100% !important; overflow: hidden !important; }
    table.dataTable {
      width: 100% !important;
      table-layout: auto !important;
      color: #111;
      background: white;
      border-radius: 8px;
      margin-top: 10px;
    }
    .dataTables_scrollHead, .dataTables_scrollBody {
      width: 100% !important;
      transition: width 0.3s ease;
    }
    .dataTables_scrollBody {
      overflow-x: auto !important;
      overflow-y: visible !important;
      -webkit-overflow-scrolling: touch;
    }

    .status-ok { color: #198754; font-weight: 600; }
    .status-warn { color: #fd7e14; font-weight: 600; }
    .status-issues { color: #dc3545; font-weight: 600; }

    /* --- Sticky Footer yang menyesuaikan sidebar --- */
    .footer {
      position: fixed;
      bottom: 0;
      left: 230px;                   /* sejajar dengan sidebar */
      width: calc(100% - 230px);     /* sisa ruang dari sidebar */
      height: 38px;
      background: #ffffff;
      padding: 4px 0;
      display: flex;
      justify-content: center;
      align-items: center;
      border-top: 1px solid #d1d5db;
      border-radius: 0;
      z-index: 5;
      transition: all 0.3s ease;     /* animasi halus */
    }
    
    .footer span {
      color: #333;
      font-weight: 500;
      margin-right: 6px;
      font-size: 12px;
      opacity: 0.8;
    }
    
    .footer img {
      height: 28px;
      opacity: 0.85;
      margin: 0 6px;
      filter: saturate(90%);
    }
    
    /* ‚úÖ Saat sidebar disembunyikan, footer melebar penuh */
    .main.expanded ~ .footer {
      left: 0;
      width: 100%;
    }

    /* ‚úÖ Loading Overlay */
    #progressOverlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.9);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 2000;
    }
    .progress-bar {
      width: 60%; height: 20px;
      background: #eee;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 12px;
    }
    .progress-bar-inner {
      width: 0%;
      height: 100%;
      background: #0d6efd;
      animation: progressAnim 2s infinite;
    }
    @keyframes progressAnim {
      0% { width: 0%; }
      50% { width: 80%; }
      100% { width: 0%; }
    }
    table.dataTable td {
      white-space: normal !important;
      word-wrap: break-word;
      word-break: break-word;
      max-width: 220px; /* sesuaikan kalau ingin kolom lebih lebar */
      vertical-align: top;
    }
    .sidebar h2 {
      font-size: 20px;
      margin-bottom: 30px;
      color: #e0f2fe;                 /* biru muda lembut */
      text-align: center;
      font-weight: 700;               /* lebih tebal */
      letter-spacing: 1.2px;          /* sedikit renggang */
      text-transform: uppercase;      /* tampil tegas */
      text-shadow: 0 0 6px rgba(255,255,255,0.3);
      border-bottom: 1px solid rgba(255,255,255,0.15);
      padding-bottom: 8px;
    }
  </style>
</head>

<body>
  <button class="toggle-btn" id="toggleBtn" onclick="toggleSidebar()">‚ùÆ</button>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <h2>RASON PANEL</h2>
    <a href="{{ url_for('main_page') }}">üè† Main Page</a>
    <a href="{{ url_for('dashboard') }}">üìä Data Resume</a>
    <a href="{{ url_for('index') }}" target="_blank">üó∫Ô∏è Map</a>
    <a href="{{ url_for('trajectory3d_page') }}" target="_blank">üåê Trajectory 3D</a>
    <a href="{{ url_for('time_accuracy') }}">‚è±Ô∏è Time Accuracy</a>
    <a href="{{ url_for('height_reach') }}">üìà Height Reach Graph</a>
    <a href="{{ url_for('data_availability_page') }}">üìÖ Data Availability</a>
    <a href="{{ url_for('settings_page') }}">‚öôÔ∏è Settings</a>
    <a href="{{ url_for('logout') }}" class="logout">üö™ Logout</a>
  </div>



  <div class="main" id="mainContent">
    <div class="header-box">
      <div class="header-icon">üìä</div>
      <div class="header-text">
        <h1>Radiosonde Data Resume</h1>
        <p>Summary of file data, metadata, and analysis results</p>
      </div>
      <div class="header-logos">
        <img src="{{ url_for('static', filename='images/bmkg.png') }}" alt="BMKG">
      </div>
    </div>

    <div class="card">
      <h2>Filters</h2>
      <form id="filterForm">
        <label>File Type:</label>
        <select id="ext">
          <option value=".bufr">.bufr</option>
          <option value=".bfh">.bfh</option>
          <option value=".bfr" selected>.bfr</option>
          <option value=".bin">.bin</option>
          <option value="">All</option>
        </select>
        <label>Start Date:</label>
        <input type="date" id="startDate">
        <label>End Date:</label>
        <input type="date" id="endDate">
        <button type="submit">Apply</button>
        <button type="button" onclick="showMetadata()">Show Metadata</button>
      </form>
    </div>

    <div class="card">
      <h2>Files</h2>
      <div id="content"></div>
    </div>
  </div>
  <div class="footer">
    <span>Powered by</span>
    <img src="{{ url_for('static', filename='images/meteomodem.png') }}">
    <img src="{{ url_for('static', filename='images/terrindofull.png') }}">
  </div>
  <!-- ‚úÖ Loading overlay element -->
  <div id="progressOverlay">
    <div class="progress-bar"><div class="progress-bar-inner"></div></div>
    <p>Loading data, please wait...</p>
  </div>

  <script>
    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const main = document.getElementById("mainContent");
      const btn = document.getElementById("toggleBtn");
      const isHidden = sidebar.classList.toggle("hidden");
      main.classList.toggle("expanded");

      btn.textContent = isHidden ? "‚ò∞" : "‚ùÆ";
      btn.classList.toggle("hidden-position", isHidden);

      setTimeout(() => {
        if ($.fn.DataTable.isDataTable('#dataTable')) {
          const table = $('#dataTable').DataTable();
          table.columns.adjust().responsive.recalc();
          $('.dataTables_scrollHead, .dataTables_scrollBody').css('width', '100%');
        }
      }, 400);
    }

    async function loadSites(params = "") {
      document.getElementById("progressOverlay").style.display = "flex";
      try {
        const res = await fetch("/api/sites" + params);
        const sites = await res.json();
        renderTable(sites, false);
      } finally {
        document.getElementById("progressOverlay").style.display = "none";
      }
    }

    async function showMetadata() {
      document.getElementById("progressOverlay").style.display = "flex";
      try {
        const ext = document.getElementById("ext").value;
        const start = document.getElementById("startDate").value;
        const end = document.getElementById("endDate").value;
        let params = `?ext=${ext}`;
        if (start) params += `&start_date=${start}`;
        if (end) params += `&end_date=${end}`;
        const res = await fetch("/api/sites_with_meta" + params);
        const sites = await res.json();
        renderTable(sites, true);
      } finally {
        document.getElementById("progressOverlay").style.display = "none";
      }
    }

    function renderTable(sites, withMeta) {
      let html = `<table id='dataTable' class='display nowrap' style='width:100%'><thead><tr>
      <th>Site</th><th>File</th><th>Data Date</th>`;
      if (withMeta)
        html += `<th>Launch</th><th>End</th><th>Status</th><th>Reason</th><th>Serial</th>
                 <th>Pressure</th><th>Height</th><th>Distance</th><th>Ascent</th>`;
      html += `<th>.bfr</th><th>WMO</th><th>Analysis</th></tr></thead><tbody>`;

      for (const [site, files] of Object.entries(sites)) {
        files.forEach(f => {
          let issues = Array.isArray(f.flight_issues) ? f.flight_issues.join(", ") : f.flight_issues || "-";
          let statusClass = (issues.includes("Ascent Stop") || issues.includes("Not reaching")) ? "status-warn"
                            : (issues !== "OK" && issues !== "-") ? "status-issues" : "status-ok";

          html += `<tr>
            <td>${site}</td>
            <td><a href='/load_from_ftp/${site}/${f.name}' target='_blank'>üìÑ</a></td>
            <td>${f.file_date || "-"}</td>`;
          if (withMeta) html += `
            <td>${f.launch_time || "-"}</td>
            <td>${f.end_time || "-"}</td>
            <td class='${statusClass}'>${issues}</td>
            <td>${f.reason_for_termination || "-"}</td>
            <td>${f.radiosonde_serial_number || "-"}</td>
            <td>${f.end_pressure || "-"}</td>
            <td>${f.max_height || "-"}</td>
            <td>${f.end_distance || "-"}</td>
            <td>${f.avg_ascent_rate || "-"}</td>`;
          html += `
            <td><a href='/download/${site}/${f.name}' target='_blank'>‚¨á</a></td>
            <td><a href='/download_wmo/${site}/${f.name}' target='_blank'>‚¨á</a></td>
            <td><a href='/raob/${site}/${f.name}' target='_blank'>üìä</a></td>
          </tr>`;
        });
      }

      html += "</tbody></table>";
      document.getElementById("content").innerHTML = html;

      if ($.fn.DataTable.isDataTable('#dataTable')) $('#dataTable').DataTable().destroy();
      $('#dataTable').DataTable({
        scrollX: true,
        autoWidth: true,
        responsive: true,
        order: [[2, "desc"]],
        initComplete: () => $('.dataTables_scrollHead, .dataTables_scrollBody').css('width', '100%')
      });
    }

    document.getElementById("filterForm").addEventListener("submit", async e => {
      e.preventDefault();
      const ext = document.getElementById("ext").value;
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      let params = `?ext=${ext}`;
      if (start) params += `&start_date=${start}`;
      if (end) params += `&end_date=${end}`;
      await loadSites(params);
    });

    loadSites("?ext={{ selected_ext }}");
  </script>
</body>
</html>
