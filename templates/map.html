<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Radiosonde Viewer</title>
  <!-- Leaflet -->
  <link rel="stylesheet" href="{{ url_for('static', filename='libs/leaflet/leaflet.css') }}">
  <script src="{{ url_for('static', filename='libs/leaflet/leaflet.js') }}"></script>
  
  <!-- Chart.js -->
  <script src="{{ url_for('static', filename='libs/chartjs/chart.umd.js') }}"></script>
  <script src="{{ url_for('static', filename='libs/chartjs/chartjs-plugin-datalabels.js') }}"></script>
  <script src="{{ url_for('static', filename='libs/chartjs/chartjs-plugin-style.js') }}"></script>
  <script src="{{ url_for('static', filename='libs/chartjs/chartjs-plugin-zoom.js') }}"></script>
  
  <!-- MapLibre -->
  <link rel="stylesheet" href="{{ url_for('static', filename='libs/maplibre/maplibre-gl.css') }}">
  <script src="{{ url_for('static', filename='libs/maplibre/maplibre-gl.js') }}"></script>
  
  <!-- Deck.gl -->
  <script src="{{ url_for('static', filename='libs/deckgl/deck.gl.min.js') }}"></script>

  <style>
    /* === BASE LAYOUT === */
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: "Inter", sans-serif;
      background: linear-gradient(to bottom right, #0a2a6b, #004aad, #0078d7);
    }
  
    #map { height: 100%; width: 100%; }
  
    /* === CONTROLS BAR === */
    #controls {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.6); /* üîπ lebih transparan */
      backdrop-filter: blur(6px);
      border: 1px solid rgba(255, 255, 255, 0.25);
      padding: 4px 8px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      gap: 5px;
      z-index: 1000;
    }
  
    /* --- Buttons --- */
    #controls button {
      background: linear-gradient(135deg, #005fa3, #0078d7);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
      transition: all 0.2s ease;
    }
    #controls button:hover {
      background: linear-gradient(135deg, #0078d7, #00a2ff);
      transform: translateY(-1px);
    }
    #chartsBtn {
      background: linear-gradient(135deg, #ff8c00, #ff6a00);
    }
    #chartsBtn:hover {
      background: linear-gradient(135deg, #ff9f1c, #ff7a00);
    }
  
    /* --- Slider (Thin & Transparent White Track) --- */
    #frameSlider {
      width: 190px;
      height: 3px;
      appearance: none;
      background: rgba(255, 255, 255, 0.4); /* üîπ transparan putih lembut */
      border-radius: 2px;
      outline: none;
      cursor: pointer;
      transition: all 0.3s ease;
    }
  
    /* Chrome / Edge / Safari */
    #frameSlider::-webkit-slider-thumb {
      appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #0078d7;
      border: 2px solid #fff;
      box-shadow: 0 0 3px rgba(0, 0, 0, 0.25);
      transition: 0.2s;
    }
    #frameSlider::-webkit-slider-thumb:hover {
      background: #00a2ff;
    }
  
    /* Firefox */
    #frameSlider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #0078d7;
      border: 2px solid #fff;
      box-shadow: 0 0 3px rgba(0, 0, 0, 0.25);
      transition: 0.2s;
    }
    #frameSlider::-moz-range-thumb:hover {
      background: #00a2ff;
    }
    #frameSlider::-moz-range-track {
      background: rgba(255, 255, 255, 0.4);
      border-radius: 2px;
    }
  
    #frameText {
      color: #004aad;
      font-weight: 600;
      font-size: 12px;
      min-width: 50px;
      text-align: center;
    }
  
    /* === PANELS === */
    #infoPanel, #metaPanel {
      position: absolute;
      top: 80px;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: #111;
      border-radius: 8px;
      box-shadow: 0 1px 5px rgba(0, 0, 0, 0.25);
      z-index: 1000;
      font-size: 13px;
      width: 240px;
      max-height: 80%;
      overflow-y: auto;
      transition: all 0.3s ease;
    }
    #infoPanel { right: 18px; }
    #metaPanel { left: 18px; }
  
    #infoPanel h4, #metaPanel h4 {
      margin: 5px 0;
      color: #004aad;
      font-size: 14px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 2px;
    }
    #infoPanel b, #metaPanel b {
      color: #004aad;
    }
  
    /* === CHART PANEL === */
    #chartsPanel {
      position: absolute;
      bottom: 75px;
      left: 50%;
      transform: translateX(-50%);
      width: 1060px;
      height: 280px;
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(8px);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
      z-index: 1000;
      padding: 8px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }
    .chartBox {
      flex: 1;
      height: 100%;
    }
    canvas {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
    }
  
    /* === TOP BAR === */
    #topBar {
      position: absolute;
      top: 8px;
      right: 10px;
      z-index: 1200;
      background: rgba(255, 255, 255, 0.6);
      padding: 3px 8px;              /* üîπ lebih tipis */
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
      font-size: 12px;               /* üîπ lebih kecil */
      line-height: 1.2;
      display: flex;
      align-items: center;
      gap: 6px;                      /* üîπ sedikit jarak antar item */
      backdrop-filter: blur(6px);
    }
    #topBar a {
      text-decoration: none;
      color: #004aad;
      font-weight: 600;
      font-size: 12px;
    }
    #topBar a:hover {
      text-decoration: underline;
    }

  
    /* === PANEL ICON BUTTONS === */
    .panel-btn {
      border: none;
      background: none;
      font-size: 16px;
      cursor: pointer;
      color: #004aad;
      transition: 0.2s;
    }
    .panel-btn:hover {
      transform: scale(1.2);
    }

    /* === UPLOAD + FILTER BAR === */
    #uploadFilterBar {
      position: absolute;
      top: 10px;              /* sejajar topbar */
      left: 10px;
      z-index: 1001;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(8px);
      padding: 6px 8px;
      border-radius: 6px;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column; /* Upload di bawah Filter */
      align-items: flex-start;
      gap: 4px;
      font-size: 11px;
      max-width: 98vw;
    }
    
    /* Bar filter di baris pertama */
    #filterBar {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    /* Upload di baris kedua */
    #uploadForm {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      padding-top: 4px;
      width: 100%;
    }
    
    /* Elemen kecil */
    #uploadFilterBar select,
    #uploadFilterBar input[type="date"],
    #uploadFilterBar input[type="file"],
    #uploadFilterBar button {
      font-size: 11px;
      padding: 3px 6px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    
    #uploadFilterBar button {
      background-color: #0078d7;
      color: white;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: 0.2s;
    }
    #uploadFilterBar button:hover {
      background-color: #005fa3;
    }
    
    /* Responsif untuk layar kecil */
    @media (max-width: 900px) {
      #uploadFilterBar {
        top: 55px; /* beri jarak aman dari topbar */
        left: 5px;
        right: 5px;
      }
      #filterBar,
      #uploadForm {
        flex-direction: column;
        align-items: stretch;
        width: 100%;
      }
      #uploadFilterBar label {
        display: none;
      }
      #uploadFilterBar select,
      #uploadFilterBar input[type="date"],
      #uploadFilterBar input[type="file"],
      #uploadFilterBar button {
        width: 100%;
      }
    }
    /* === STATUS TEXT === */
    .statusText {
      font-size: 11px;
      color: #004aad;
      font-weight: 600;
      margin-left: 6px;
      min-width: 180px;
      display: inline-block;
      white-space: nowrap;
    }
    
    .statusText.loading {
      color: #ff8c00;
      animation: pulse 1.2s infinite;
    }
    
    .statusText.success {
      color: #28a745;
    }
    
    .statusText.error {
      color: #e74c3c;
    }
    
    @keyframes pulse {
      0% { opacity: 0.3; }
      50% { opacity: 1; }
      100% { opacity: 0.3; }
    }
  </style>

</head>
<body>
  <div id="map"></div>
  <!-- Upload + Filter Container -->
  <div id="uploadFilterBar">
    <!-- üîπ FILTER BAR -->
    <div id="filterBar">
      <label>Site:</label>
      <select id="siteSelect">
        <option value="aceh">Aceh</option>
        <option value="tarakan">Tarakan</option>
        <option value="sorong">Sorong</option>
        <option value="cilacap">Cilacap</option>
        <option value="pangkalanbun">Pangkalanbun</option>
        <option value="ranai">Ranai</option>
      </select>
  
      <label>Date:</label>
      <input type="date" id="dateSelect">
  
      <label>Hour:</label>
      <select id="hourSelect">
        <option value="00">00Z</option>
        <option value="12">12Z</option>
      </select>
  
      <label>Type:</label>
      <select id="typeSelect">
        <option value=".bfr">.bfr</option>
        <option value=".bufr">.bufr</option>
        <option value=".bfh">.bfh</option>
        <option value=".bin">.bin</option>
      </select>
  
      <button onclick="applyFilter()">Apply</button>
    </div>
  
    <!-- üîπ UPLOAD MANUAL (status gabung di sini) -->
    <form method="POST" enctype="multipart/form-data" id="uploadForm">
      <div style="display:flex; align-items:center; gap:6px; flex-wrap:wrap;">
        <input type="file" name="rasonfiles" accept=".bufr,.bfr,.bfh,.bin">
        <button type="submit">Upload Radiosonde</button>
        <span id="statusText" class="statusText"></span>
      </div>
    </form>
  </div>

  <!-- Logout button -->
  <div id="topBar">
    Hi, {{ user }} |
    <a href="{{ url_for('main_page') }}">üè† Home</a> |
    <a href="{{ url_for('logout') }}">üö™ Logout</a>
  </div>

  <!-- Metadata panel -->
  <div id="metaPanel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <b>Station Metadata</b>
      <button id="toggleMeta" class="panel-btn">‚àí</button>
    </div>
    <div id="metaContent">No metadata</div>
  </div>

  <!-- Per-level info panel -->
  <div id="infoPanel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <b>Level Info</b>
      <button id="toggleInfo" class="panel-btn">‚àí</button>
    </div>
    <div id="infoContent">No data loaded</div>
  </div>

  <!-- Charts Panel -->
  <div id="chartsPanel">
    <div class="chartBox"><canvas id="dirChart"></canvas></div>
    <div class="chartBox"><canvas id="windChart"></canvas></div>
    <div class="chartBox"><canvas id="thermoChart"></canvas></div>
  </div>

  <!-- Controls -->
  <div id="controls">
    <button type="button" class="ctrl-btn" onclick="prevFrame()">‚èÆ</button>
    <button type="button" class="ctrl-btn" onclick="togglePlay()"><span id="playBtn">‚ñ∂</span></button>
    <button type="button" class="ctrl-btn" onclick="nextFrame()">‚è≠</button>
    
    <input type="range" id="frameSlider" min="0" value="0" step="1">
    <span id="frameText">0/0</span>
    
    <button type="button" class="ctrl-btn toggle" onclick="toggleCharts()" id="chartsBtn">üìä Hide Charts</button>
  </div>

  <script>
    // --- Map ---
    const map = L.map('map', { zoomControl: false }).setView([0,0], 3);
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    
    // --- Base maps ---
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '¬© OpenStreetMap'
    });
    
    const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19, attribution: 'Tiles ¬© Esri ‚Äî Source: Esri, i-cubed, USDA, USGS'
    });
    
    const googleHybrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
      maxZoom: 20, attribution: '¬© Google Maps Hybrid'
    });

    // === HIMA GIBS (Band 13 Clean IR) ===
    const himawariLayer = L.tileLayer.wms(
      "https://gibs.earthdata.nasa.gov/wms/epsg3857/best/wms.cgi",
      {
        layers: "Himawari_AHI_Band13_Clean_Infrared",
        format: "image/png",
        transparent: true,
        opacity: 0.7,
        tileSize: 512,
        version: "1.3.0",
        //time: "2025-10-06T12:00:00Z",
        attribution: "NASA GIBS / Himawari-8 AHI Band13"
      }
    );
    
    // --- Default layer ---
    esriSat.addTo(map);
    
    // --- Layer control menu ---
    const baseMaps = {
      "üõ∞Ô∏è Satellite (Esri)": esriSat,
      "üó∫Ô∏è OpenStreetMap": osm,
      "üß≠ Hybrid (Google)": googleHybrid
    };
    
    const overlayMaps = {
      //"üå§ Himawari-8 True Color": himawariTrueColor,
      //"üå° Himawari-8 Infrared": himawariIR,
      //"üïí Himawari-8 IR (GIBS, time-aware)": himawariWMS, 
      "üå§ Himawari-8 IR (Band 13)": himawariLayer
    };

    L.control.layers(baseMaps, overlayMaps, { position: "bottomleft" }).addTo(map);

    // --- State ---
    let frame = 0, total = 0, playing = false, timer = null;
    let balloonMarker = null, pathLine = null;
    let allLevels = [];  // full profile in memory
    let launchDateUTC = null; // Date object (UTC) parsed from metadata.launch_time

    // --- Balloon icon ---
    const balloonIcon = L.divIcon({
      html: "<div style='font-size:64px;'>üéà</div>",
      className: "",
      iconSize: [64, 64],
      iconAnchor: [32, 64]
    });

    // --- Charts ---  
    // === Register Plugins ===
    Chart.register(ChartDataLabels);
    
    // === Common Chart Options ===
    const commonOptions = {
      responsive: true,
      maintainAspectRatio: false,
      elements: {
        line: { tension: 0.25, borderWidth: 2 },
        point: { radius: 2, hoverRadius: 5 }
      },
      plugins: {
        legend: {
          position: 'bottom',
          align: 'center',
          labels: {
            color: '#222',             // üåü teks legend hitam gelap
            boxWidth: 12,
            padding: 12,
            usePointStyle: true,
            pointStyle: 'circle',
            font: { size: 13, weight: 'bold' }
          }
        },
        datalabels: { display: false },
        style: {
          shadowOffsetX: 1,
          shadowOffsetY: 2,
          shadowBlur: 5,
          shadowColor: 'rgba(0,0,0,0.3)'
        },
        zoom: {
          zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'xy' },
          pan: { enabled: true, mode: 'xy' }
        },
        title: {
          display: false,
          color: '#222',
          font: { size: 16, weight: 'bold' }
        }
      },
      scales: {
        x: {
          grid: { color: 'rgba(0,0,0,0.1)' },
          ticks: { color: '#333', font: { size: 12, weight: 'bold' } },   // üåü angka sumbu X hitam
          title: { display: true, color: '#111', font: { size: 13, weight: 'bold' } } // üåü label sumbu X
        },
        y: {
          grid: { color: 'rgba(0,0,0,0.1)' },
          ticks: { color: '#333', font: { size: 12, weight: 'bold' } },   // üåü angka sumbu Y hitam
          title: { display: true, color: '#111', font: { size: 13, weight: 'bold' } }
        }
      }
    };
    
    // === Wind Direction Chart ===
    const dirChartData = {
      datasets: [
        {
          label: 'Wind Direction (¬∞)',
          data: [],
          borderColor: '#28c76f',
          backgroundColor: '#28c76f70',
          showLine: true
        }
      ]
    };
    const dirChart = new Chart(document.getElementById('dirChart'), {
      type: 'scatter',
      data: dirChartData,
      options: {
        ...commonOptions,
        plugins: {
          ...commonOptions.plugins,
          title: {
            display: true,
            text: 'Wind Direction Profile',
            color: '#111',
            font: { size: 17, weight: 'bold' }
          }
        },
        scales: {
          ...commonOptions.scales,
          x: { ...commonOptions.scales.x, title: { display: true, text: 'Direction (¬∞)' }, min: 0, max: 360 },
          y: { ...commonOptions.scales.y, title: { display: true, text: 'Height (m)' }, suggestedMin: 0, suggestedMax: 30000 }
        }
      }
    });
    
    // === Wind Speed & Ascent Rate ===
    const windChartData = {
      datasets: [
        {
          label: 'Ascent Rate (m/s)',
          data: [],
          borderColor: '#007bff',
          backgroundColor: '#007bff80',
          showLine: true
        },
        {
          label: 'Wind Speed (m/s)',
          data: [],
          borderColor: '#e74c3c',
          backgroundColor: '#e74c3c80',
          showLine: true
        }
      ]
    };
    const windChart = new Chart(document.getElementById('windChart'), {
      type: 'scatter',
      data: windChartData,
      options: {
        ...commonOptions,
        plugins: {
          ...commonOptions.plugins,
          title: {
            display: true,
            text: 'Wind Speed & Ascent Rate',
            color: '#111',
            font: { size: 17, weight: 'bold' }
          }
        },
        scales: {
          ...commonOptions.scales,
          x: { ...commonOptions.scales.x, title: { display: true, text: 'Speed / Ascent (m/s)', color: '#111' } },
          y: { ...commonOptions.scales.y, title: { display: true, text: 'Height (m)' }, suggestedMin: 0, suggestedMax: 30000 }
        }
      }
    });
    
    // === Thermodynamic Chart ===
    const thermoChartData = {
      datasets: [
        {
          label: 'Temperature (¬∞C)',
          data: [],
          borderColor: '#ffa500',
          backgroundColor: '#ffa50070',
          showLine: true
        },
        {
          label: 'Dewpoint (¬∞C)',
          data: [],
          borderColor: '#00bcd4',
          backgroundColor: '#00bcd470',
          showLine: true
        }
      ]
    };
    const thermoChart = new Chart(document.getElementById('thermoChart'), {
      type: 'scatter',
      data: thermoChartData,
      options: {
        ...commonOptions,
        plugins: {
          ...commonOptions.plugins,
          title: {
            display: true,
            text: 'Temperature & Dewpoint Profile',
            color: '#111',
            font: { size: 17, weight: 'bold' }
          }
        },
        scales: {
          ...commonOptions.scales,
          x: { ...commonOptions.scales.x, title: { display: true, text: 'Temperature (¬∞C)', color: '#111' } },
          y: { ...commonOptions.scales.y, title: { display: true, text: 'Height (m)' }, suggestedMin: 0, suggestedMax: 30000 }
        }
      }
    });

    // --- Toggle Charts Panel ---
    function toggleCharts() {
      const panel = document.getElementById("chartsPanel");
      const btn = document.getElementById("chartsBtn");
      if (panel.style.display === "none") {
        panel.style.display = "flex";
        btn.innerText = "üìä Hide Charts";
      } else {
        panel.style.display = "none";
        btn.innerText = "üìä Show Charts";
      }
    }

    // --- Helpers for UTC time ---
    function parseLaunchUTC(str) {
      // expects "YYYY-MM-DD HH:MM:SS UTC"
      if (!str) return null;
      const iso = str.replace(' UTC', 'Z'); // force UTC
      const d = new Date(iso);
      return isNaN(d.getTime()) ? null : d;
    }
    function formatUTC(date) {
      // YYYY-MM-DD HH:MM:SS UTC
      const pad = n => String(n).padStart(2,'0');
      const y = date.getUTCFullYear();
      const m = pad(date.getUTCMonth()+1);
      const d = pad(date.getUTCDate());
      const hh = pad(date.getUTCHours());
      const mm = pad(date.getUTCMinutes());
      const ss = pad(date.getUTCSeconds());
      return `${y}-${m}-${d} ${hh}:${mm}:${ss} UTC`;
    }

    // Pretty labels for selected metadata keys
    const METADATA_LABELS = {
      launch_time: "Launch Time",
      station_lat: "Station Lat",
      station_lon: "Station Lon",
      station_height_m: "Station Height",
      radiosonde_serial_number: "Serial Number",
      radiosonde_operating_frequency: "Frequency",
      reason_for_termination: "Reason for Termination",
      type_of_pressure_sensor: "Pressure Sensor",
      type_of_temperature_sensor: "Temperature Sensor",
      type_of_humidity_sensor: "Humidity Sensor",
      type_of_balloon: "Balloon Type",
      type_of_gas_used_in_balloon: "Balloon Gas",
      software_version: "Software"
    };
  
    // Preferred display order
    const META_PRIMARY_ORDER = [
      "launch_time",
      "station_lat",
      "station_lon",
      "station_height_m",
      "radiosonde_serial_number",
      "radiosonde_operating_frequency",
      "reason_for_termination",
      "type_of_pressure_sensor",
      "type_of_temperature_sensor",
      "type_of_humidity_sensor",
      "type_of_balloon",
      "type_of_gas_used_in_balloon",
      "software_version"
    ];

    // Fallback maps to render "code ‚Äì meaning" if backend only sends numbers.
    const SENSOR_MAPS = {
      pressure_sensor_type: {0:"Unknown",1:"Aneroid",2:"Capacitive",3:"Other"},
      type_of_pressure_sensor: {0:"Unknown",1:"Aneroid",2:"Capacitive",3:"Other"},
    
      temperature_sensor_type: {0:"Unknown",1:"Thermistor",2:"Platinum",3:"Other"},
      type_of_temperature_sensor: {0:"Unknown",1:"Thermistor",2:"Platinum",3:"Other"},
    
      humidity_sensor_type: {0:"Unknown",1:"Hair",2:"Capacitive",3:"Carbon",4:"Other"},
      type_of_humidity_sensor: {0:"Unknown",1:"Hair",2:"Capacitive",3:"Carbon",4:"Other"},
    
      balloon_type: {0:"Unknown",1:"Latex",2:"Polyethylene",3:"Other"},
      type_of_balloon: {0:"Unknown",1:"Latex",2:"Polyethylene",3:"Other"},
    
      balloon_gas_type: {0:"Unknown",1:"Hydrogen",2:"Helium"},
      type_of_gas_used_in_balloon: {0:"Unknown",1:"Hydrogen",2:"Helium"},
    
      balloon_manufacturer: {0:"Unknown",1:"Totex",2:"Kaysam",3:"Other"},
    
      reason_for_termination: {
        0:"Not specified",1:"Balloon burst",2:"Battery exhausted",
        3:"Receiver failure",4:"Telemetry interrupted",5:"Manual termination",6:"Other"
      }
    };
    
    // Turn "1" ‚Üí "1 ‚Äì Aneroid" for known keys;
    // leave values that are already "1 ‚Äì Aneroid" unchanged.
    function formatMetaValue(key, value) {
      if (value == null || value === "") return "-";
    
      // If already formatted like "2 ‚Äì Hydrogen"
      if (typeof value === "string" && value.includes("‚Äì")) return value;
    
      // Try map with exact key
      let map = SENSOR_MAPS[key];
      if (!map) {
        // Try fallback: remove "type_of_" prefix
        const altKey = key.replace(/^type_of_/, "");
        map = SENSOR_MAPS[altKey];
      }
    
      const code = Number(value);
      if (map && Number.isFinite(code)) {
        const meaning = map[code] ?? "Unknown";
        return `${code} ‚Äì ${meaning}`;
      }
    
      return value;
    }
    
    // Map primary keys to possible alias keys the backend might send
    const ALT_KEYS = {
      type_of_pressure_sensor: "pressure_sensor_type",
      type_of_temperature_sensor: "temperature_sensor_type",
      type_of_humidity_sensor: "humidity_sensor_type",
      type_of_balloon: "balloon_type",
      type_of_gas_used_in_balloon: "balloon_gas_type",
      balloon_manufacturer: "balloon_manufacturer" // (no alias, keep for consistency)
    };
    
    // Safely retrieve the raw value for a metadata field (try primary, then alias)
    function getMeta(meta, key) {
      const v = meta[key];
      if (v !== undefined && v !== null && v !== "") return v;
      const alt = ALT_KEYS[key];
      if (alt && meta[alt] !== undefined && meta[alt] !== null && meta[alt] !== "") return meta[alt];
      return "-";
    }
    
    // --- Load metadata ---
    fetch('/metadata')
      .then(r => r.ok ? r.json() : {})
      .then(meta => {
        if (!meta || meta.error) return;
    
        launchDateUTC = parseLaunchUTC(meta.launch_time);
        // Sinkronkan overlay WMS ke waktu peluncuran
        if (launchDateUTC) {
          setHimawariTime(launchDateUTC);
        }
        let html = "";
    
        // --- Station info ---
        html += `<h4>üìç Station</h4>`;
        html += `<b>Launch Time</b>: ${formatMetaValue("launch_time", meta.launch_time)}<br>`;
        html += `<b>Lat</b>: ${meta.station_lat ?? "-"}<br>`;
        html += `<b>Lon</b>: ${meta.station_lon ?? "-"}<br>`;
        html += `<b>Height</b>: ${meta.station_height_m ?? "-"} m<br>`;
    
        // --- Radiosonde ---
        html += `<h4>üéà Radiosonde</h4>`;
        html += `<b>Serial</b>: ${meta.radiosonde_serial_number ?? "-"}<br>`;
        html += `<b>Frequency</b>: ${meta.radiosonde_operating_frequency ?? "-"}<br>`;
        html += `<b>Pressure Sensor</b>: ${formatMetaValue("type_of_pressure_sensor", getMeta(meta, "type_of_pressure_sensor"))}<br>`;
        html += `<b>Temp Sensor</b>: ${formatMetaValue("type_of_temperature_sensor", getMeta(meta, "type_of_temperature_sensor"))}<br>`;
        html += `<b>Humidity Sensor</b>: ${formatMetaValue("type_of_humidity_sensor", getMeta(meta, "type_of_humidity_sensor"))}<br>`;
        html += `<b>Software</b>: ${meta.software_version ?? "-"}<br>`;
    
        // --- Balloon ---
        html += `<h4>üéà Balloon</h4>`;
        html += `<b>Type</b>: ${formatMetaValue("type_of_balloon", getMeta(meta, "type_of_balloon"))}<br>`;
        html += `<b>Gas</b>: ${formatMetaValue("type_of_gas_used_in_balloon", getMeta(meta, "type_of_gas_used_in_balloon"))}<br>`;
        if (meta.balloon_manufacturer || getMeta(meta, "balloon_manufacturer") !== "-") {
          html += `<b>Manufacturer</b>: ${formatMetaValue("balloon_manufacturer", getMeta(meta, "balloon_manufacturer"))}<br>`;
        }

    
        // --- Flight results ---
        html += `<h4>‚úà Flight</h4>`;
        if (Array.isArray(meta.flight_issues) && meta.flight_issues.length > 0) {
          html += `<b>Status</b>: ${meta.flight_issues.join(", ")}<br>`;
        }
        html += `<b>Termination</b>: ${formatMetaValue("reason_for_termination", meta.reason_for_termination)}<br>`;
        html += `<b>End Pressure</b>: ${meta.end_pressure ?? "-"}<br>`;
        html += `<b>Max Height</b>: ${meta.max_height ?? "-"}<br>`;
        html += `<b>End Distance</b>: ${meta.end_distance ?? "-"}<br>`;
        html += `<b>Ascent Rate</b>: ${meta.avg_ascent_rate ?? "-"}<br>`;
    
        document.getElementById("metaContent").innerHTML = html;
      })
      .catch(() => {});

 
    // --- Load all levels ---
    initLevels();

    async function initLevels() {
      try {
        const r = await fetch('/all_levels');
        if (r.ok) {
          const arr = await r.json();
          if (Array.isArray(arr) && arr.length > 0) {
            allLevels = arr;
            total = allLevels.length;
            document.getElementById("frameSlider").max = Math.max(0, total - 1);
            updateFrameText(); // initial text with time if possible
            loadRason();
            return;
          }
        }
      } catch {}
      // Fallback using server-side total + /value?frame=
      const srvTotal = {{ total|default(0) }};
      if (srvTotal > 0) {
        const promises = [];
        for (let i = 0; i < srvTotal; i++) {
          promises.push(fetch(`/value?frame=${i}`).then(x => x.json()).catch(() => null));
        }
        const results = (await Promise.all(promises)).filter(x => x && !x.error);
        if (results.length) {
          allLevels = results;
          total = allLevels.length;
          document.getElementById("frameSlider").max = Math.max(0, total - 1);
          updateFrameText();
          loadRason();
        }
      }
    }

    function isFiniteNumber(x) {
      return typeof x === 'number' && Number.isFinite(x);
    }

    function updateFrameText() {
      let base = `${frame + 1}/${total}`;
      const data = allLevels[frame];
      if (data && data.time_s != null && launchDateUTC) {
        const t = Number(data.time_s) || 0;
        const ts = new Date(launchDateUTC.getTime() + t * 1000);
        base += ` | ${formatUTC(ts)} (t=${Math.round(t)} s)`;
      }
      document.getElementById("frameText").innerText = base;
    }

    function loadRason() {
      if (!allLevels.length) {
        document.getElementById("infoContent").innerText = "No radiosonde";
        return;
      }

      frame = (frame % allLevels.length + allLevels.length) % allLevels.length;
      const data = allLevels[frame];

      // UI
      document.getElementById("frameSlider").value = frame;
      updateFrameText();
      // ... di dalam loadRason(), setelah const data = allLevels[frame];
      if (data && launchDateUTC && typeof data.time_s === "number") {
        const ts = new Date(launchDateUTC.getTime() + (data.time_s * 1000));
        setHimawariTime(ts);
      }
      
      // Info (numbers 1 decimal; full precision for lat/lon)
      let html = "";
      for (const [k,v] of Object.entries(data)) {
        if (v == null) continue;
        if (k === "latitude" || k === "longitude") {
          html += `<b>${k}</b>: ${v}¬∞<br>`;
        } else if (typeof v === "number") {
          html += `<b>${k}</b>: ${Number(v).toFixed(1)}<br>`;
        } else {
          html += `<b>${k}</b>: ${v}<br>`;
        }
      }
      document.getElementById("infoContent").innerHTML = html || "No data";

      // Charts (rebuild subset 0..frame)
      const subset = allLevels.slice(0, frame + 1);
      windChartData.datasets[0].data = subset.map(l => ({ x: l.ascent_rate_mps ?? null, y: l.height_m }));
      windChartData.datasets[1].data = subset.map(l => ({ x: l.wind_speed_mps ?? null, y: l.height_m }));
      thermoChartData.datasets[0].data = subset.map(l => ({ x: l.temp_C ?? null, y: l.height_m }));
      thermoChartData.datasets[1].data = subset.map(l => ({ x: l.dewpoint_C ?? null, y: l.height_m }));
      dirChartData.datasets[0].data = subset.map(l => ({ x: l.wind_dir_deg ?? null, y: l.height_m }));
      
      // Auto-scale >25 km
      const h = data.height_m;
      if (isFiniteNumber(h) && h > 25000) {
        windChart.options.scales.y.suggestedMax = null;
        thermoChart.options.scales.y.suggestedMax = null;
        dirChart.options.scales.y.suggestedMax = null;
      } else {
        windChart.options.scales.y.suggestedMax = 25000;
        thermoChart.options.scales.y.suggestedMax = 25000;
        dirChart.options.scales.y.suggestedMax = 25000;
      }
      
      windChart.update();
      thermoChart.update();
      dirChart.update();
      

      // Balloon path up to current frame
      const trackCoords = subset
        .filter(l => isFiniteNumber(l.latitude) && isFiniteNumber(l.longitude))
        .map(l => [l.latitude, l.longitude]);

      if (isFiniteNumber(data.latitude) && isFiniteNumber(data.longitude)) {
        const latlng = [data.latitude, data.longitude];
        if (balloonMarker) balloonMarker.setLatLng(latlng);
        else balloonMarker = L.marker(latlng, { icon: balloonIcon }).addTo(map);
      
        // ‚úÖ Zoom otomatis ke posisi balon saat load pertama
        if (frame === 0) {
          if (trackCoords.length > 1) {
            setTimeout(() => map.fitBounds(trackCoords), 0);
          } else {
            map.setView(latlng, 9); // zoom manual kalau hanya 1 titik
          }
        }
      }


      if (trackCoords.length >= 2) {
        if (pathLine) pathLine.setLatLngs(trackCoords);
        else pathLine = L.polyline(trackCoords, { color: "red" }).addTo(map);
      } else if (pathLine) {
        pathLine.setLatLngs(trackCoords);
      }
    }

    function nextFrame() {
      if (!allLevels.length) return;
    
      // kalau belum frame terakhir ‚Üí lanjut
      if (frame < total - 1) {
        frame++;
        loadRason();
      } else {
        // kalau sudah frame terakhir ‚Üí stop play otomatis
        clearInterval(timer);
        playing = false;
        document.getElementById("playBtn").innerText = "‚ñ∂";
      }
    }
    
    function prevFrame() {
      if (!allLevels.length) return;
      if (frame > 0) {
        frame--;
        loadRason();
      } else {
        frame = 0;
      }
    }
    
    function togglePlay() {
      if (!allLevels.length) return;
    
      const playBtn = document.getElementById("playBtn");
      if (playing) {
        clearInterval(timer);
        playing = false;
        playBtn.innerText = "‚ñ∂";
      } else {
        playing = true;
        playBtn.innerText = "‚è∏";
        timer = setInterval(nextFrame, 1000);
      }
    }
    
    document.getElementById("frameSlider").addEventListener("input", function () {
      if (!allLevels.length) return;
      frame = parseInt(this.value, 10) || 0;
      loadRason();
    });

    // --- Metadata toggle ---
    document.addEventListener("DOMContentLoaded", () => {
      const metaBtn = document.getElementById("toggleMeta");
      const metaContent = document.getElementById("metaContent");
      metaBtn.addEventListener("click", () => {
        const hidden = metaContent.style.display === "none";
        metaContent.style.display = hidden ? "block" : "none";
        metaBtn.textContent = hidden ? "‚àí" : "+";
      });
    
      const infoBtn = document.getElementById("toggleInfo");
      const infoContent = document.getElementById("infoContent");
      infoBtn.addEventListener("click", () => {
        const hidden = infoContent.style.display === "none";
        infoContent.style.display = hidden ? "block" : "none";
        infoBtn.textContent = hidden ? "‚àí" : "+";
      });
    });

    // === SIMPAN FILTERS ===
    function saveFilterState() {
      localStorage.setItem("siteSelect", document.getElementById("siteSelect").value);
      localStorage.setItem("dateSelect", document.getElementById("dateSelect").value);
      localStorage.setItem("hourSelect", document.getElementById("hourSelect").value);
      localStorage.setItem("typeSelect", document.getElementById("typeSelect").value);
    }
    
    // === RESTORE FILTERS SAAT PAGE LOAD ===
    window.addEventListener("load", () => {
      const site = localStorage.getItem("siteSelect");
      const date = localStorage.getItem("dateSelect");
      const hour = localStorage.getItem("hourSelect");
      const type = localStorage.getItem("typeSelect");
    
      if (site) document.getElementById("siteSelect").value = site;
      if (date) document.getElementById("dateSelect").value = date;
      if (hour) document.getElementById("hourSelect").value = hour;
      if (type) document.getElementById("typeSelect").value = type;
    });

    async function applyFilter() {
      const statusEl = document.getElementById("statusText");
      statusEl.textContent = "üîÑ Getting file from FTP...";
      statusEl.className = "statusText loading";
    
      saveFilterState();
    
      const site  = document.getElementById("siteSelect").value;
      const date  = document.getElementById("dateSelect").value;
      const hour  = document.getElementById("hourSelect").value;
      const ftype = document.getElementById("typeSelect").value;
    
      if (!site || !date || !hour || !ftype) {
        alert("‚ö†Ô∏è Mohon pilih site, tanggal, jam, dan tipe file!");
        statusEl.textContent = "‚ö†Ô∏è Incomplete filter";
        statusEl.className = "statusText error";
        return;
      }
    
      try {
        const res = await fetch("/api/filter", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams({ site, date, hour, ftype }),
          credentials: "same-origin"
        });
        const data = await res.json();
    
        if (data.status === "no_files") {
          statusEl.textContent = "‚ö†Ô∏è No files found";
          statusEl.className = "statusText error";
          alert(data.message || "No matching files found");
          return;
        }
        if (data.status !== "ok" || !Array.isArray(data.files) || data.files.length === 0) {
          statusEl.textContent = "‚ùå Filter error";
          statusEl.className = "statusText error";
          alert("‚ùå Filter error.");
          return;
        }
    
        statusEl.textContent = "üì¶ Decoding BUFR...";
        const chosen = data.files.sort().slice(-1)[0];
        const selectedDateTime = new Date(`${date}T${hour}:00:00Z`);
        if (map.hasLayer(himawariLayer)) setHimawariTime(selectedDateTime);
    
        // sedikit delay biar smooth
        setTimeout(() => {
          statusEl.textContent = "‚úÖ Success ‚Äî File Loaded";
          statusEl.className = "statusText success";
          window.location.href = `/load_from_ftp/${encodeURIComponent(site)}/${encodeURIComponent(chosen)}`;
        }, 800);
      } catch (e) {
        console.error(e);
        alert("‚ùå Gagal menghubungi /api/filter");
        statusEl.textContent = "‚ùå Connection failed";
        statusEl.className = "statusText error";
      }
    }

    // === UPLOAD RADIOSONDE (versi DOM native, bukan fetch) ===
    const uploadForm = document.getElementById("uploadForm");
    const fileInput = document.getElementById("rasonFile");
    const uploadBtn = document.getElementById("uploadBtn");
    const statusEl = document.getElementById("statusText");
    
    uploadForm.addEventListener("submit", (e) => {
      if (!fileInput.files.length) {
        e.preventDefault();
        alert("‚ö†Ô∏è Please choose a file first!");
        return;
      }
    
      // tampilkan status sementara
      statusEl.textContent = "üîÑ Uploading file...";
      statusEl.className = "statusText loading";
    
      // biarkan form submit normal (page reload otomatis)
      uploadBtn.disabled = true;
    
      // kalau upload berhasil, Flask akan reload otomatis,
      // jadi kita tidak perlu handle res di JS
    });
    
        // === Fungsi untuk update waktu Himawari ===
        function setHimawariTime(dateUTC) {
          // Bulatkan ke kelipatan 10 menit (slot GIBS)
          const rounded = new Date(Math.floor(dateUTC.getTime() / (10 * 60 * 1000)) * (10 * 60 * 1000));
          const iso = rounded.toISOString().split('.')[0] + "Z";
          console.log("[Himawari] Update time:", iso);
          himawariLayer.setParams({ time: iso });
          if (map.hasLayer(himawariLayer)) {
            map.addLayer(himawariLayer);
          }
        }

  </script>
</body>
</html>
