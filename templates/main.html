<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Main Menu - Radiosonde Monitoring</title>
  <link href="{{ url_for('static', filename='libs/fonts/inter/inter.css') }}" rel="stylesheet">

  <!-- ‚úÖ Leaflet lokal -->
  <link rel="stylesheet" href="{{ url_for('static', filename='libs/leaflet/leaflet.css') }}">
  <script src="{{ url_for('static', filename='libs/leaflet/leaflet.js') }}"></script>

  <!-- ‚úÖ jQuery lokal -->
  <script src="{{ url_for('static', filename='libs/jquery/jquery-3.6.0.min.js') }}"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", sans-serif;
      display: flex;
      flex-direction: row;
      min-height: 100vh;
      background: linear-gradient(to bottom right, #0a2a6b, #004aad, #0078d7);
      color: white;
      overflow-y: auto;
      transition: all 0.3s ease;
    }

    /* Sidebar */
    .sidebar {
      width: 230px;
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(8px);
      border-right: 1px solid rgba(255,255,255,0.15);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 10px;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      z-index: 10;
      transition: transform 0.3s ease;
    }

    .sidebar.hidden {
      transform: translateX(-240px);
    }

    .sidebar h2 { font-size: 18px; margin-bottom: 30px; color: #dbeafe; text-align: center; }
    .sidebar a {
      display: block; text-decoration: none; color: white;
      width: 100%; padding: 12px 15px; border-radius: 8px;
      text-align: left; margin: 8px 0; transition: background 0.3s;
    }
    .sidebar a:hover { background: rgba(255,255,255,0.15); }
    .logout { margin-top: auto; font-size: 14px; padding: 8px 14px; background: rgba(255,255,255,0.1); border-radius: 6px; color: #fca5a5; text-decoration: none; }
    .logout:hover { background: rgba(255,255,255,0.2); }

    /* Tombol toggle terpisah dari sidebar */
    .toggle-btn {
      position: fixed;
      top: 50%;
      left: 220px;
      transform: translateY(-50%);
      width: 28px;
      height: 28px;
      border: none;
      border-radius: 50%;
      background: rgba(255,255,255,0.25);
      color: white;
      font-size: 14px;
      cursor: pointer;
      z-index: 50;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }

    .toggle-btn:hover {
      background: rgba(255,255,255,0.4);
    }

    .toggle-btn.hidden-position {
      left: 10px;
    }

    /* Main area */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 40px;
      margin-left: 230px;
      transition: margin-left 0.3s ease;
    }

    .main.expanded {
      margin-left: 0;
    }

    .header-box {
      position: relative;
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 20px 30px;
      box-shadow: 0 6px 25px rgba(0,0,0,0.3);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 18px;
      margin-bottom: 35px;
    }

    .header-icon {
      width: 50px; height: 50px; background: rgba(255,255,255,0.15);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 26px; color: #dbeafe;
    }

    .header-text h1 { margin: 0; font-size: 26px; font-weight: 600; letter-spacing: 0.5px; }
    .header-text p { margin: 4px 0 0; font-size: 14px; color: #dbeafe; opacity: 0.9; }

    .header-logos { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); display: flex; gap: 12px; align-items: center; }
    .header-logos img { height: 36px; opacity: 0.9; }

    /* Grid box */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      padding: 18px;
      text-align: left;
      color: white;
      transition: transform 0.2s, background 0.2s;
    }

    .card:hover { transform: translateY(-4px); background: rgba(255,255,255,0.15); }
    .card h3 { margin: 0 0 10px; font-size: 18px; color: #fff; }
    .card p { font-size: 13px; margin: 3px 0; color: #dbeafe; }

    #indoMap {
      width: 100%; height: 75vh; border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      margin-bottom: 30px;
    }

    /* Footer */
    .footer {
      background: #ffffff;
      padding: 25px 0;
      display: flex;
      justify-content: center;
      align-items: center;
      border-top: 1px solid #e5e7eb;
      border-radius: 0 0 10px 10px;
    }

    .footer span {
      color: #222;
      font-weight: 600;
      margin-right: 10px;
      font-size: 15px;
    }

    .footer img {
      height: 60px;
      opacity: 0.95;
      margin: 0 10px;
    }
  </style>
</head>

<body>

  <!-- Tombol toggle terpisah -->
  <button class="toggle-btn" id="toggleBtn" onclick="toggleSidebar()">‚ùÆ</button>

  <div class="sidebar" id="sidebar">
    <h2>Radiosonde Monitoring</h2>
    <a href="{{ url_for('dashboard') }}" target="_blank">üìä Data Resume</a>
    <a href="{{ url_for('index') }}" target="_blank">üó∫Ô∏è Map</a>
    <a href="{{ url_for('time_accuracy') }}" target="_blank">‚è±Ô∏è Time Accuracy</a>
    <a href="{{ url_for('height_reach') }}" target="_blank">üìà Height Reach Graph</a>
    <a href="{{ url_for('settings_page') }}" target="_blank">‚öôÔ∏è Settings</a>
    <a href="{{ url_for('logout') }}" class="logout">üö™ Logout</a>
  </div>

  <div class="main" id="mainContent">
    <!-- Header -->
    <div class="header-box">
      <div class="header-icon">üéà</div>
      <div class="header-text">
        <h1>Radiosonde Data Monitoring</h1>
        <p>Real-time upper-air observation and analysis dashboard</p>
      </div>
      <div class="header-logos">
        <img src="{{ url_for('static', filename='images/bmkg.png') }}" alt="BMKG">
      </div>
    </div>

    <!-- Map -->
    <div id="indoMap"></div>

    <!-- Dynamic Site Status -->
    <div id="statusGrid" class="card-grid">
      <p>Loading latest site status...</p>
    </div>

    <!-- Footer -->
    <div class="footer">
      <span>Powered by</span>
      <img src="{{ url_for('static', filename='images/meteomodem.png') }}" alt="Meteomodem Logo">
      <img src="{{ url_for('static', filename='images/terrindofull.png') }}" alt="Terrindo Logo">
    </div>
  </div>

  <script>
    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const main = document.getElementById("mainContent");
      const btn = document.getElementById("toggleBtn");

      sidebar.classList.toggle("hidden");
      main.classList.toggle("expanded");

      if (sidebar.classList.contains("hidden")) {
        btn.textContent = "‚ò∞";
        btn.classList.add("hidden-position");
      } else {
        btn.textContent = "‚ùÆ";
        btn.classList.remove("hidden-position");
      }
    }

    // Load status dari API
    async function loadLatestStatus() {
      try {
        const res = await fetch("/api/latest_status");
        const data = await res.json();
        const grid = document.getElementById("statusGrid");
        grid.innerHTML = "";

        data.slice(0, 6).forEach(site => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <h3>üìç ${site.site}</h3>
            <p><b>Launch:</b> ${site.launch_time}</p>
            <p><b>End:</b> ${site.end_time}</p>
            <p><b>Status:</b> ${site.status}</p>
            <p><b>Termination:</b> ${site.termination}</p>
            <p><b>End Pressure:</b> ${site.end_pressure}</p>
            <p><b>Max Height:</b> ${site.max_height}</p>
            <p><b>Distance:</b> ${site.end_distance}</p>
            <p><b>Ascent Rate:</b> ${site.ascent_rate}</p>
          `;
          grid.appendChild(card);
        });
      } catch (err) {
        console.error("‚ùå Gagal memuat status:", err);
        document.getElementById("statusGrid").innerHTML = "<p>Failed to load data.</p>";
      }
    }

    loadLatestStatus();
    setInterval(loadLatestStatus, 10 * 60 * 1000);

    // Leaflet Map
    var map = L.map('indoMap').setView([-2, 118], 5);
    
    // --- Panes & z-index (marker di atas provinsi) ---
    map.createPane('provincePane');
    map.createPane('markerPane');
    map.getPane('provincePane').style.zIndex = 400;
    map.getPane('markerPane').style.zIndex = 650;
    
    // --- Base layer ---
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    // --- Layer provinsi (lebih transparan supaya marker jelas) ---
    fetch("{{ url_for('static', filename='geojson/indonesia-provinces.geojson') }}")
      .then(res => res.json())
      .then(data => {
        L.geoJSON(data, {
          pane: 'provincePane',
          style: {
            fillColor: "#3388ff",
            weight: 1,
            color: "white",
            fillOpacity: 0.25
          },
          onEachFeature: (feature, layer) => {
            layer.on({
              mouseover: e => e.target.setStyle({ fillOpacity: 0.4 }),
              mouseout:  e => e.target.setStyle({ fillOpacity: 0.25 })
            });
          }
        }).addTo(map);
      });
    
    // --- Titik site (koordinat tetap di sini) ---
    const sites = [
      { name: "Aceh",         lat: 5.52256,   lon: 95.41685 },
      { name: "Tarakan",      lat: 3.32708,   lon: 117.57052 },
      { name: "Sorong",       lat: -0.89059,  lon: 131.28581 },
      { name: "Cilacap",      lat: -7.71897,  lon: 109.01487 },
      { name: "Pangkalanbun", lat: -2.70508,  lon: 111.66573 },
      { name: "Ranai",        lat: 3.95929,   lon: 108.38576 }
    ];
    
    // --- Map status ‚Üí warna ---
    function getColorByStatus(status) {
      switch (String(status || '').toLowerCase()) {
        case "online":    return "limegreen";
        case "inflight":  return "#007bff";
        case "preparing": return "orange";
        case "offline":   return "red";
        default:          return "gray";
      }
    }
    
    // --- LayerGroup khusus marker ---
    const siteMarkers = L.layerGroup({ pane: 'markerPane' }).addTo(map);
    
    // --- Normalisasi nama untuk pencocokan robust ---
    function norm(s) {
      return String(s || '')
        .toLowerCase()
        .replace(/\s+/g, '')
        .replace(/[^a-z0-9]/g, '');
    }
    
    // --- Gambar marker offline sebagai fallback awal ---
    function drawStaticMarkers() {
      siteMarkers.clearLayers();
      sites.forEach(site => {
        const color = getColorByStatus('offline');
        const m = L.circleMarker([site.lat, site.lon], {
          pane: 'markerPane',
          radius: 10,
          fillColor: color,
          color: "#fff",
          weight: 2,
          fillOpacity: 0.9
        }).addTo(siteMarkers);
        m.bindTooltip(
          `<b>${site.name}</b><br>
           Status: <span style="color:${color};font-weight:bold">offline</span><br>
           <small>Last update: -</small>`,
          { direction: "top", offset: [0, -5] }
        );
      });
    }
    drawStaticMarkers(); // tampil duluan biar nggak ‚Äúkosong‚Äù
    
    // --- Ambil status nyata dari backend (bawa cookie login!) ---
    async function updateSiteStatus() {
      try {
        const res = await fetch("/api/status", { credentials: 'same-origin' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
    
        const statuses = await res.json();
        // Index by normalized name
        const byName = new Map(statuses.map(st => [norm(st.site), st]));
    
        siteMarkers.clearLayers();
        sites.forEach(site => {
          const st = byName.get(norm(site.name)) || { status: 'offline', update: '-' };
          const color = getColorByStatus(st.status);
    
          const m = L.circleMarker([site.lat, site.lon], {
            pane: 'markerPane',
            radius: 10,
            fillColor: color,
            color: "#fff",
            weight: 2,
            fillOpacity: 0.9
          }).addTo(siteMarkers);
    
          m.bindTooltip(
            `<b>${site.name}</b><br>
             Status: <span style="color:${color};font-weight:bold">${st.status}</span><br>
             <small>Last update: ${st.update || "-"}</small>`,
            { direction: "top", offset: [0, -5] }
          );
        });
      } catch (err) {
        console.error("‚ö†Ô∏è Gagal update status dari /api/status:", err);
        // Biarkan fallback statis yang sudah tergambar
      }
    }
    
    // --- Legend (pojok kanan bawah) ---
    const legend = L.control({ position: "bottomright" });
    legend.onAdd = function () {
      const div = L.DomUtil.create("div", "info legend");
      const statuses = [
        { color: "red",       label: "Offline"   },
        { color: "limegreen", label: "Online"    },
        { color: "orange",    label: "Preparing" },
        { color: "#007bff",   label: "Inflight"  }
      ];
      Object.assign(div.style, {
        background: "rgba(255,255,255,0.9)",
        padding: "10px 12px",
        borderRadius: "8px",
        boxShadow: "0 2px 6px rgba(0,0,0,0.3)",
        fontSize: "13px",
        color: "#111"
      });
      div.innerHTML = "<b>Status Legend</b><br>";
      statuses.forEach(s => {
        div.innerHTML += `
          <div style="display:flex;align-items:center;margin-top:4px;">
            <span style="width:14px;height:14px;border-radius:50%;background:${s.color};margin-right:8px;"></span>
            ${s.label}
          </div>`;
      });
      return div;
    };
    legend.addTo(map);
    
    // --- Jalankan update berkala ---
    updateSiteStatus();                  // tarik data pertama kali
    setInterval(updateSiteStatus, 5 * 60 * 1000); // tiap 5 menit
    


  </script>
</body>
</html>
